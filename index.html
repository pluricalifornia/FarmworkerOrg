<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>California Farmworker Organizations Map</title>
  
  <!-- Load the ArcGIS Maps SDK for JavaScript core API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css"/>
  
  <!-- Add Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Avenir Next', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    #viewDiv {
      height: 100%;
      width: 100%;
    }
    
    #infoPanel {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 99;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      width: 300px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      padding: 15px;
    }
    
    #legendPanel {
      position: absolute;
      bottom: 30px;
      left: 20px;
      z-index: 99;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 15px;
    }
    
    #debugPanel {
      position: absolute;
      bottom: 30px;
      right: 20px;
      z-index: 99;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 15px;
      max-width: 300px;
      max-height: 200px;
      overflow: auto;
      font-size: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .filter-btn {
      margin: 5px 5px 5px 0;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background-color: #f0f0f0;
      cursor: pointer;
    }
    
    .filter-btn.active {
      background-color: #0079c1;
      color: white;
    }
    
    .org-item {
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    
    .org-name {
      font-weight: bold;
      color: #0079c1;
    }
    
    .title-bar {
      background-color: #0079c1;
      color: white;
      padding: 10px 15px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
    }
    
    .stats-container {
      display: flex;
      margin-bottom: 15px;
    }
    
    .stat-box {
      flex: 1;
      text-align: center;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      margin-right: 8px;
    }
    
    .stat-box:last-child {
      margin-right: 0;
    }
    
    .stat-value {
      font-size: 1.2em;
      font-weight: bold;
      color: #0079c1;
    }
    
    .stat-label {
      font-size: 0.8em;
      color: #666;
    }
    
    .action-btn {
      background-color: #0079c1;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 10px;
      width: 100%;
      cursor: pointer;
    }
    
    .action-btn:hover {
      background-color: #005e95;
    }

    #resetViewBtn {
      position: absolute;
      bottom: 150px;
      left: 20px;
      z-index: 99;
      background-color: white;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 10px 15px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="viewDiv"></div>
  
  <div id="infoPanel">
    <div class="title-bar">
      <h2 style="margin: 0; font-size: 1.2em;">California Farmworker Organizations</h2>
    </div>
    
    <div class="stats-container">
      <div class="stat-box">
        <div class="stat-value" id="orgCount">0</div>
        <div class="stat-label">Organizations</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="fundingTotal">$0</div>
        <div class="stat-label">Total Funding</div>
      </div>
    </div>
    
    <div style="margin-bottom: 15px;">
      <button id="filterAll" class="filter-btn active">All</button>
      <button id="filterLarge" class="filter-btn">&gt; $10M</button>
      <button id="filterMed" class="filter-btn">$1-10M</button>
      <button id="filterSmall" class="filter-btn">&lt; $1M</button>
    </div>
    
    <div id="selectedCity" style="margin-bottom: 15px; font-weight: bold;"></div>
    <div id="orgsList" style="margin-top: 10px;"></div>
  </div>
  
  <div id="legendPanel">
    <h3 style="margin-top: 0; margin-bottom: 10px;">Funding Legend</h3>
    <div class="legend-item">
      <div class="legend-color" style="background-color: rgb(204, 0, 0);"></div>
      <div>Over $20 Million</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: rgb(255, 0, 0);"></div>
      <div>$10-20 Million</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: rgb(255, 153, 0);"></div>
      <div>$5-10 Million</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: rgb(255, 204, 0);"></div>
      <div>$1-5 Million</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: rgb(76, 175, 80);"></div>
      <div>Under $1 Million</div>
    </div>
    <p style="margin-bottom: 0; font-size: 0.8em;">* Size of marker indicates funding amount</p>
  </div>
  
  <div id="debugPanel">
    <h3 style="margin-top: 0; margin-bottom: 10px;">Debug Info</h3>
    <div id="debugContent"></div>
  </div>
  
  <button id="resetViewBtn">Reset View</button>

  <!-- Load ArcGIS API -->
  <script src="https://js.arcgis.com/4.32/"></script>

  <script>
    // Debug function to log information
    function debugLog(message) {
      const debugContent = document.getElementById("debugContent");
      const logItem = document.createElement("div");
      logItem.textContent = message;
      debugContent.appendChild(logItem);
      console.log(message);
    }
    
    // Complete city coordinates lookup for California
    const cityCoordinates = {
      // Original cities
      "Bakersfield": [-119.0187, 35.3733],
      "Fresno": [-119.7871, 36.7378],
      "Sacramento": [-121.4944, 38.5816],
      "Los Angeles": [-118.2437, 34.0522],
      "Oxnard": [-119.1792, 34.1975],
      "Modesto": [-120.9969, 37.6391],
      "Delano": [-119.2471, 35.7688],
      "Tehachapi": [-118.4489, 35.1322],
      "Glendora": [-117.8651, 34.1361],
      "Winton": [-120.6107, 37.3855],
      "Keene": [-118.5573, 35.2271],
      "Visalia": [-119.2921, 36.3302],
      "Brawley": [-115.5311, 32.9787],
      "Ventura": [-119.2290, 34.2746],
      "Coachella": [-116.1733, 33.6803],
      "Chico": [-121.8375, 39.7285],
      "Indio": [-116.2023, 33.7206],
      "El Centro": [-115.5310, 32.7920],
      "Dade City": [-82.1962, 28.3647],
      
      // All missing cities with correct coordinates
      "Watsonville": [-121.7568, 36.9102],
      "Santa Rosa": [-122.7141, 38.4405],
      "Moreno Valley": [-117.2296, 33.9424],
      "San Marcos": [-117.1661, 33.1434],
      "Mountain View": [-122.0838, 37.3860],
      "Felton": [-122.0727, 37.0513],
      "Napa": [-122.2886, 38.2975],
      "Clovis": [-119.7030, 36.8252],
      "Walnut Grove": [-121.5102, 38.2424],
      "Brentwood": [-121.6958, 37.9318],
      "Parlier": [-119.5271, 36.6116],
      "Orange Cove": [-119.3135, 36.6252],
      "San Francisco": [-122.4194, 37.7749],
      "Calistoga": [-122.5797, 38.5787],
      
      // Other California cities for reference
      "San Diego": [-117.1611, 32.7157],
      "San Jose": [-121.8853, 37.3382],
      "Oakland": [-122.2712, 37.8044],
      "Long Beach": [-118.1937, 33.7701],
      "Anaheim": [-117.9143, 33.8366],
      "Santa Ana": [-117.8678, 33.7455],
      "Riverside": [-117.3755, 33.9806],
      "Stockton": [-121.2908, 37.9577],
      "Irvine": [-117.8265, 33.6846],
      "Fremont": [-121.9885, 37.5485],
      "San Bernardino": [-117.2898, 34.1083],
      "Santa Clarita": [-118.5429, 34.3917],
      "Fontana": [-117.4350, 34.0922],
      "Moreno Valley": [-117.2296, 33.9424],
      "Rancho Cucamonga": [-117.5931, 34.1064],
      "Ontario": [-117.6509, 34.0633],
      "Lancaster": [-118.1542, 34.6868],
      "Palm Springs": [-116.5453, 33.8303],
      "Salinas": [-121.6555, 36.6777],
      "Pomona": [-117.7499, 34.0551],
      "Hayward": [-122.0808, 37.6688],
      "Escondido": [-117.0865, 33.1192],
      "Sunnyvale": [-122.0364, 37.3688],
      "Torrance": [-118.3406, 33.8358],
      "Pasadena": [-118.1445, 34.1478],
      "Orange": [-117.8531, 33.7879],
      "Fullerton": [-117.9242, 33.8703],
      "Thousand Oaks": [-118.8375, 34.1706],
      "Concord": [-122.0312, 37.9779],
      "Visalia": [-119.2921, 36.3302],
      "Simi Valley": [-118.7845, 34.2694],
      "Victorville": [-117.2928, 34.5362],
      "Vallejo": [-122.2566, 38.1041],
      "Berkeley": [-122.2727, 37.8716],
      "El Monte": [-118.0289, 34.0686],
      "Downey": [-118.1331, 33.9401],
      "Costa Mesa": [-117.9184, 33.6411],
      "Inglewood": [-118.3531, 33.9617],
      "Carlsbad": [-117.3505, 33.1581],
      "Fairfield": [-122.0376, 38.2493],
      "Temecula": [-117.1486, 33.4936],
      "Antioch": [-121.8052, 38.0049],
      "Richmond": [-122.3477, 37.9357],
      "Murrieta": [-117.2139, 33.5539],
      "Norwalk": [-118.0812, 33.9022],
      "Daly City": [-122.4702, 37.7058],
      "Burbank": [-118.3089, 34.1808],
      "Santa Maria": [-120.4357, 34.9530],
      "El Cajon": [-116.9625, 32.7948],
      "Rialto": [-117.3703, 34.1064],
      "San Mateo": [-122.3255, 37.5630],
      "Jurupa Valley": [-117.4854, 34.0025],
      "Compton": [-118.2200, 33.8958],
      "Vista": [-117.2428, 33.2000],
      "South Gate": [-118.2123, 33.9425],
      "Mission Viejo": [-117.6719, 33.6000],
      "Vacaville": [-121.9877, 38.3565],
      "Carson": [-118.2813, 33.8316],
      "Hesperia": [-117.3008, 34.4263],
      "Santa Monica": [-118.4912, 34.0195],
      "Westminster": [-117.9939, 33.7597],
      "Santa Barbara": [-119.6982, 34.4208],
      "Redding": [-122.3917, 40.5865],
      "Chico": [-121.8375, 39.7285],
      "Newport Beach": [-117.9292, 33.6189],
      "San Leandro": [-122.1561, 37.7249],
      "San Rafael": [-122.5311, 37.9735],
      "Camarillo": [-119.0377, 34.2164],
      "Merced": [-120.4829, 37.3022],
      "Alhambra": [-118.1270, 34.0953],
      "Livermore": [-121.7680, 37.6819],
      "Tracy": [-121.4252, 37.7397],
      "Citrus Heights": [-121.2811, 38.7071],
      "Folsom": [-121.1760, 38.6779],
      "Pleasanton": [-121.8746, 37.6624],
      "Manteca": [-121.2160, 37.7974],
      "Milpitas": [-121.8950, 37.4323],
      "Redwood City": [-122.2363, 37.4852],
      "Davis": [-121.7405, 38.5449],
      "Madera": [-120.0607, 36.9613],
      "Petaluma": [-122.6367, 38.2324],
      "Turlock": [-120.8465, 37.4946],
      "Tulare": [-119.3473, 36.2077],
      "Hollister": [-121.4016, 36.8525],
      "Lodi": [-121.2722, 38.1302],
      "Cupertino": [-122.0322, 37.3230],
      
      // Non-California locations
      "Montgomery": [-86.3077, 32.3792],
      "Austin": [-97.7431, 30.2672],
      "Woodburn": [-122.8554, 45.1437],
      "Washington": [-77.0369, 38.9072]
    };
    
    // Global variables
    let view;
    let graphicsLayer;
    let organizations = [];
    let cityGroups = {};
    let currentFilter = 'all';
    let selectedCity = null;
    
    // Function to parse revenue values
    function parseRevenue(revenueStr) {
      if (!revenueStr) return 0;
      return parseInt(revenueStr.toString().replace(/\$|,/g, '')) || 0;
    }
    
    // Function to format revenue for display
    function formatRevenue(value) {
      if (value >= 1000000) {
        return `$${(value / 1000000).toFixed(1)}M`;
      } else if (value >= 1000) {
        return `$${(value / 1000).toFixed(1)}K`;
      }
      return `$${value}`;
    }
    
    // Get marker size based on revenue
    function getMarkerSize(revenue) {
      if (revenue > 20000000) return 24;
      if (revenue > 10000000) return 20;
      if (revenue > 5000000) return 16;
      if (revenue > 1000000) return 12;
      return 10;
    }
    
    // Get marker color based on revenue
    function getMarkerColor(revenue) {
      if (revenue > 20000000) return [204, 0, 0, 0.8];
      if (revenue > 10000000) return [255, 0, 0, 0.8];
      if (revenue > 5000000) return [255, 153, 0, 0.8];
      if (revenue > 1000000) return [255, 204, 0, 0.8];
      return [76, 175, 80, 0.8];
    }
    
    // Use the AMD pattern as recommended by ArcGIS
    require([
      "esri/Map", 
      "esri/views/MapView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/geometry/Point",
      "esri/widgets/BasemapToggle",
      "esri/widgets/Home",
      "esri/geometry/Extent",
      "esri/request"
    ], (ArcGISMap, MapView, Graphic, GraphicsLayer, Point, BasemapToggle, Home, Extent, esriRequest) => {
      debugLog("ArcGIS modules loaded successfully");
      
      try {
        // Create map with basemap
        const map = new ArcGISMap({
          basemap: "topo-vector"
        });
        
        // Create graphics layer for organizations
        graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);
        
        // Create the map view
        view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-119.4179, 36.7783], // Center on California
          zoom: 6
        });
        
        // Add basemap toggle
        const basemapToggle = new BasemapToggle({
          view: view,
          nextBasemap: "satellite"
        });
        view.ui.add(basemapToggle, "bottom-right");
        
        // Define California extent
        const caExtent = new Extent({
          xmin: -124.4096,
          ymin: 32.5343,
          xmax: -114.1308,
          ymax: 42.0095,
          spatialReference: {
            wkid: 4326
          }
        });
        
        // Add home widget
        const homeWidget = new Home({
          view: view,
          viewpoint: {
            targetGeometry: caExtent
          }
        });
        view.ui.add(homeWidget, "top-left");
        
        // Create a popup template for marker clicks
        const popupTemplate = {
          title: "{city}",
          content: [
            {
              type: "text",
              text: "{count} organizations with total funding of {totalRevenueDisplay}"
            }
          ]
        };
        
        // Function to filter graphics based on revenue
        function filterGraphics(minRevenue, maxRevenue = Infinity) {
          graphicsLayer.graphics.forEach(graphic => {
            const totalRevenue = graphic.attributes.totalRevenue;
            if (totalRevenue >= minRevenue && totalRevenue < maxRevenue) {
              graphic.visible = true;
            } else {
              graphic.visible = false;
            }
          });
        }
        
        // Function to update info panel with organizations data
        function updateInfoPanel(cityName = null) {
          const orgsListElement = document.getElementById("orgsList");
          orgsListElement.innerHTML = "";
          
          let displayOrgs = [];
          
          if (cityName) {
            // Selected city view
            document.getElementById("selectedCity").textContent = `${cityName}, CA`;
            displayOrgs = organizations.filter(org => org.City === cityName);
            
            // Add back button
            const backButton = document.createElement("button");
            backButton.textContent = "Back to All Cities";
            backButton.className = "action-btn";
            backButton.onclick = function() {
              selectedCity = null;
              updateInfoPanel();
              view.goTo(caExtent);
            };
            orgsListElement.appendChild(backButton);
          } else {
            // All cities view
            document.getElementById("selectedCity").textContent = "";
            
            // Group by city and create city list
            for (const city in cityGroups) {
              const cityInfo = cityGroups[city];
              
              // Apply revenue filter
              if (currentFilter === 'small' && cityInfo.totalRevenue >= 1000000) continue;
              if (currentFilter === 'med' && (cityInfo.totalRevenue < 1000000 || cityInfo.totalRevenue >= 10000000)) continue;
              if (currentFilter === 'large' && cityInfo.totalRevenue < 10000000) continue;
              
              const cityItem = document.createElement("div");
              cityItem.className = "org-item";
              cityItem.innerHTML = `
                <div class="org-name">${city}</div>
                <div>${cityInfo.count} organizations</div>
                <div>${formatRevenue(cityInfo.totalRevenue)}</div>
              `;
              
              // Add click event to show city detail
              cityItem.style.cursor = "pointer";
              cityItem.onclick = function() {
                selectedCity = city;
                updateInfoPanel(city);
                
                // Zoom to city
                if (cityCoordinates[city]) {
                  const point = new Point({
                    longitude: cityCoordinates[city][0],
                    latitude: cityCoordinates[city][1]
                  });
                  view.goTo({
                    target: point,
                    zoom: 10
                  });
                }
              };
              
              orgsListElement.appendChild(cityItem);
            }
            
            return;
          }
          
          // Sort organizations by revenue
          displayOrgs.sort((a, b) => parseRevenue(b["Total revenues"]) - parseRevenue(a["Total revenues"]));
          
          // Display organizations for selected city
          displayOrgs.forEach(org => {
            const revenue = parseRevenue(org["Total revenues"]);
            
            // Apply revenue filter
            if (currentFilter === 'small' && revenue >= 1000000) return;
            if (currentFilter === 'med' && (revenue < 1000000 || revenue >= 10000000)) return;
            if (currentFilter === 'large' && revenue < 10000000) return;
            
            const orgItem = document.createElement("div");
            orgItem.className = "org-item";
            orgItem.innerHTML = `
              <div class="org-name">${org.Name || "Unknown"}</div>
              <div>${org["Total revenues"] || "$0"}</div>
              <div>${org["IRS 501(c) type"] || ""}</div>
            `;
            orgsListElement.appendChild(orgItem);
          });
        }
        
        // Process organizations data
        function processOrganizations() {
          // Group organizations by city
          cityGroups = {};
          let totalRevenue = 0;
          let caOrgCount = 0;
          let missingCitiesFound = false;
          
          debugLog(`Processing ${organizations.length} organizations...`);
          
          organizations.forEach(org => {
            // Check if organization has valid data
            if (!org || !org.City || !org.State) {
              debugLog(`Skipping invalid organization: ${JSON.stringify(org)}`);
              return;
            }
            
            if (org.State === 'CA') {
              const city = org.City.trim();
              const revenue = parseRevenue(org["Total revenues"]);
              
              caOrgCount++;
              totalRevenue += revenue;
              
              if (!cityGroups[city]) {
                cityGroups[city] = {
                  city: city,
                  count: 0,
                  totalRevenue: 0,
                  organizations: []
                };
                
                // Check if we have coordinates for this city
                if (!cityCoordinates[city]) {
                  debugLog(`No coordinates found for city: ${city}`);
                  missingCitiesFound = true;
                }
              }
              
              cityGroups[city].count++;
              cityGroups[city].totalRevenue += revenue;
              cityGroups[city].organizations.push(org);
            }
          });
          
          // Update statistics
          document.getElementById("orgCount").textContent = caOrgCount;
          document.getElementById("fundingTotal").textContent = formatRevenue(totalRevenue);
          
          debugLog(`Found ${caOrgCount} organizations in California with total revenue of ${formatRevenue(totalRevenue)}`);
          
          if (missingCitiesFound) {
            debugLog(`WARNING: Some cities don't have coordinates. Check the console for details.`);
          }
          
          // Create markers for each city
          Object.keys(cityGroups).forEach(city => {
            const cityInfo = cityGroups[city];
            
            // Check if we have coordinates for this city
            if (cityCoordinates[city]) {
              const [longitude, latitude] = cityCoordinates[city];
              
              // Create point
              const point = new Point({
                longitude: longitude,
                latitude: latitude
              });
              
              // Create marker symbol
              const markerSymbol = {
                type: "simple-marker",
                size: getMarkerSize(cityInfo.totalRevenue),
                color: getMarkerColor(cityInfo.totalRevenue),
                outline: {
                  color: [255, 255, 255],
                  width: 2
                }
              };
              
              // Create graphic
              const graphic = new Graphic({
                geometry: point,
                symbol: markerSymbol,
                attributes: {
                  city: city,
                  count: cityInfo.count,
                  organizations: cityInfo.organizations,
                  totalRevenue: cityInfo.totalRevenue,
                  totalRevenueDisplay: formatRevenue(cityInfo.totalRevenue)
                },
                popupTemplate: popupTemplate
              });
              
              // Add to graphics layer
              graphicsLayer.add(graphic);
            }
          });
          
          // Update info panel
          updateInfoPanel();
        }
        
        // Function to load and process CSV data
        function loadData() {
          debugLog("Attempting to load CSV data...");
          
          // Try all possible filenames
          const filesToTry = [
            "cleandata_farmworkerorganizations.csv",
            "./cleandata_farmworkerorganizations.csv",
            "cleandata_farmworker-organizations.csv",
            "./cleandata_farmworker-organizations.csv",
            "cleandata_farmworkerorganizations 1.csv",
            "./cleandata_farmworkerorganizations 1.csv"
          ];
          
          let fileIndex = 0;
          
          function tryNextFile() {
            if (fileIndex >= filesToTry.length) {
              debugLog("All file attempts failed. Using mock data.");
              organizations = [];
              processOrganizations();
              return;
            }
            
            const filename = filesToTry[fileIndex];
            debugLog(`Trying to load: ${filename}`);
            
            esriRequest(filename, {
              responseType: "text"
            }).then(function(response) {
              debugLog(`CSV file loaded successfully from: ${filename}`);
              
              // Use Papa Parse for better CSV parsing
              Papa.parse(response.data, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                  organizations = results.data;
                  debugLog(`Parsed ${organizations.length} organizations from CSV`);
                  processOrganizations();
                },
                error: function(error) {
                  debugLog(`Error parsing CSV: ${error}`);
                  fileIndex++;
                  tryNextFile();
                }
              });
            }).catch(function(error) {
              debugLog(`Error loading ${filename}: ${error}`);
